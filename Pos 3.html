<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathirage Electronics - Repair Manager</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 15px;
            background: #f8f9fa;
            max-width: 100%;
            margin: 0 auto;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #007bff;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            margin-top: 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .job {
            background: #f1f1f1;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            position: relative;
        }
        .job-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }
        .payment-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }
        .delivered { background: green; }
        .ready { background: orange; }
        .progress { background: #007bff; }
        .pending { background: red; }
        .paid { background: green; }
        .partial { background: orange; }
        .unpaid { background: red; }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .search-box {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 5px;
            margin: 15px 0;
        }
        #exportBtn {
            background: #28a745;
        }
        #searchBtn {
            background: #ffc107;
            color: #212529;
        }
        .complete-btn, .edit-btn, .edit-payment-btn, .sms-btn, .receipt-btn {
            padding: 6px 10px;
            font-size: 12px;
            margin-top: 5px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .complete-btn { background: #28a745; color: white; }
        .edit-btn { background: #17a2b8; color: white; }
        .edit-payment-btn { background: #ffc107; color: #212529; }
        .sms-btn { background: #007bff; color: white; }
        .receipt-btn { background: #6f42c1; color: white; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: left;
        }
        .modal-title {
            margin-top: 0;
            color: #007bff;
        }
        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f1f1f1;
            border: none;
            font-weight: bold;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }

        /* Footer */
        .footer {
            margin-top: 30px;
            padding: 15px;
            background: #007bff;
            color: white;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
        }

        /* Job Number Badge */
        .job-number {
            background: #6c757d;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }

        /* Receipt Styles */
        .receipt-content {
            display: none;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-content, .receipt-content * {
                visibility: visible;
            }
            .receipt-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 80mm;
                margin: 0 auto;
                padding: 5mm;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                line-height: 1.4;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Pathirage Electronics</h1>
        <p style="color: #666; font-size: 14px;">Repair Shop Manager (LKR)</p>

        <div class="form">
            <label>Customer Name *</label>
            <input type="text" id="customerName" placeholder="e.g. John Doe" required>

            <label>Phone *</label>
            <input type="tel" id="customerPhone" placeholder="e.g. 0712345678" required>

            <label>Address</label>
            <textarea id="customerAddress" rows="2" placeholder="House #, Street, City"></textarea>

            <label>Brand</label>
            <input type="text" id="deviceBrand" placeholder="e.g. Samsung, Apple, Dell">

            <label>Model *</label>
            <input type="text" id="deviceModel" placeholder="e.g. Galaxy S23, MacBook Pro" required>

            <label>Issue Description</label>
            <textarea id="issueDesc" rows="3" placeholder="Describe the problem..."></textarea>

            <label>Repair Date (Received)</label>
            <input type="date" id="repairDate">

            <label>Expected Delivery Date</label>
            <input type="date" id="deliveryDate">

            <label>Status</label>
            <select id="status">
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Ready for Pickup">Ready for Pickup</option>
            </select>

            <button id="saveBtn">üíæ Save Repair Job</button>
        </div>

        <div class="actions">
            <input type="text" id="searchInput" class="search-box" placeholder="üîç Search by Name, Phone, or Job Number (e.g. PE-2025-0001)">
            <button id="searchBtn">Search</button>
            <button id="exportBtn">üì§ Export All Jobs</button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="active">üîß Active Jobs</button>
            <button class="tab" data-tab="all">üìã All Jobs</button>
        </div>

        <div id="jobList">
            <!-- Jobs will appear here -->
        </div>

        <div class="footer">
            ‚òéÔ∏è Hotline: 070 607 7 607<br>
            üõ†Ô∏è Pathirage Electronics - We Care For Your Devices
        </div>
    </div>

    <!-- Complete Job Modal -->
    <div id="completeModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">‚úÖ Complete Repair</h3>
            <label>Repair Price (LKR)</label>
            <input type="number" id="modalPrice" min="0" step="0.01" placeholder="e.g. 1500.00">

            <label>Amount Paid (LKR)</label>
            <input type="number" id="modalPaid" min="0" step="0.01" placeholder="e.g. 1000.00">

            <div class="modal-actions">
                <button id="modalSaveBtn">üíæ Save & Mark Ready for Pickup</button>
                <button id="modalCancelBtn">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">‚úèÔ∏è Edit Price & Payment</h3>
            <label>Repair Price (LKR)</label>
            <input type="number" id="editPrice" min="0" step="0.01" placeholder="e.g. 1500.00">

            <label>Amount Paid (LKR)</label>
            <input type="number" id="editPaid" min="0" step="0.01" placeholder="e.g. 1000.00">

            <div class="modal-actions">
                <button id="editSaveBtn">üíæ Save Changes</button>
                <button id="editCancelBtn">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div id="editJobModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">‚úèÔ∏è Edit Job Details</h3>
            <input type="hidden" id="editJobId">
            <label>Job Number</label>
            <input type="text" id="editJobNumber" readonly>
            
            <label>Customer Name</label>
            <input type="text" id="editCustomerName" placeholder="e.g. John Doe">

            <label>Phone</label>
            <input type="tel" id="editCustomerPhone" placeholder="e.g. 0712345678">

            <label>Address</label>
            <textarea id="editCustomerAddress" rows="2" placeholder="House #, Street, City"></textarea>

            <label>Brand</label>
            <input type="text" id="editDeviceBrand" placeholder="e.g. Samsung, Apple, Dell">

            <label>Model</label>
            <input type="text" id="editDeviceModel" placeholder="e.g. Galaxy S23, MacBook Pro">

            <label>Issue Description</label>
            <textarea id="editIssueDesc" rows="3" placeholder="Describe the problem..."></textarea>

            <label>Repair Date</label>
            <input type="date" id="editRepairDate">

            <label>Expected Delivery Date</label>
            <input type="date" id="editDeliveryDate">

            <label>Status</label>
            <select id="editStatus">
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Ready for Pickup">Ready for Pickup</option>
                <option value="Delivered">Delivered</option>
            </select>

            <div class="modal-actions">
                <button id="saveEditBtn">üíæ Save Changes</button>
                <button id="cancelEditBtn">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Receipt Container (hidden until printed) -->
    <div class="receipt-content" id="receiptContent">
        <!-- Receipt content will be injected here -->
    </div>

    <script>
        let jobs = JSON.parse(localStorage.getItem('repairJobs')) || [];
        const saveBtn = document.getElementById('saveBtn');
        const jobListEl = document.getElementById('jobList');
        const exportBtn = document.getElementById('exportBtn');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const tabs = document.querySelectorAll('.tab');
        const receiptContent = document.getElementById('receiptContent');

        // Modal Elements
        const completeModal = document.getElementById('completeModal');
        const paymentModal = document.getElementById('paymentModal');
        const editJobModal = document.getElementById('editJobModal');

        const modalPrice = document.getElementById('modalPrice');
        const modalPaid = document.getElementById('modalPaid');
        const editPrice = document.getElementById('editPrice');
        const editPaid = document.getElementById('editPaid');

        const editJobId = document.getElementById('editJobId');
        const editJobNumber = document.getElementById('editJobNumber');
        const editCustomerName = document.getElementById('editCustomerName');
        const editCustomerPhone = document.getElementById('editCustomerPhone');
        const editCustomerAddress = document.getElementById('editCustomerAddress');
        const editDeviceBrand = document.getElementById('editDeviceBrand');
        const editDeviceModel = document.getElementById('editDeviceModel');
        const editIssueDesc = document.getElementById('editIssueDesc');
        const editRepairDate = document.getElementById('editRepairDate');
        const editDeliveryDate = document.getElementById('editDeliveryDate');
        const editStatus = document.getElementById('editStatus');

        const modalSaveBtn = document.getElementById('modalSaveBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const editSaveBtn = document.getElementById('editSaveBtn');
        const editCancelBtn = document.getElementById('editCancelBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        let currentJobId = null;
        let currentTab = 'active'; // active | all

        // Shop Info
        const SHOP_NAME = "Pathirage Electronics";
        const HOTLINE = "070 607 7 607";

        // Set today's date as default
        document.getElementById('repairDate').valueAsDate = new Date();
        document.getElementById('deliveryDate').valueAsDate = new Date(Date.now() + 86400000 * 3);

        // Tab Switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                renderJobs(searchInput.value.trim());
            });
        });

        // Generate next job number
        function generateJobNumber() {
            const year = new Date().getFullYear();
            let nextNumber = 1;

            const currentYearJobs = jobs.filter(job => job.jobNumber && job.jobNumber.startsWith(`PE-${year}-`));
            if (currentYearJobs.length > 0) {
                const numbers = currentYearJobs.map(job => {
                    const parts = job.jobNumber.split('-');
                    return parseInt(parts[2]) || 0;
                });
                nextNumber = Math.max(...numbers) + 1;
            }

            return `PE-${year}-${nextNumber.toString().padStart(4, '0')}`;
        }

        // Generate RECEIVED SMS Text
        function generateReceivedSMSText(customerName, deviceBrand, deviceModel, jobNumber) {
            return `Hello ${customerName},\n\nThank you for choosing ${SHOP_NAME}!\nWe've received your device: ${deviceBrand} ${deviceModel} for repair.\n\nüìå Your Job Number: ${jobNumber}\nWe'll notify you when it's ready for pickup.\n‚òéÔ∏è Hotline: ${HOTLINE}\n\n‚Äî ${SHOP_NAME}`;
        }

        // Generate READY SMS Text
        function generateReadySMSText(customerName, jobNumber, repairPrice, amountPaid) {
            const balance = repairPrice - amountPaid;
            let msg = `Hello ${customerName},\n\nüéâ Great news! Your device is ready for pickup at ${SHOP_NAME}!\n\nüìå Job Number: ${jobNumber}\nüí∞ Repair Price: Rs ${repairPrice.toFixed(2)}\nüíµ Amount Paid: Rs ${amountPaid.toFixed(2)}\nüí≥ Balance Due: Rs ${balance.toFixed(2)}\n\nPlease visit us soon to collect your device.\n‚òéÔ∏è Hotline: ${HOTLINE}\nThank you for trusting us!`;
            return msg;
        }

        // Generate Detailed SMS Text
        function generateDetailedSMSText(job) {
            const balance = job.repairPrice - job.amountPaid;
            let msg = `Hello ${job.customerName},\n\n`;
            msg += `üìå Job Number: ${job.jobNumber}\n`;
            msg += `Thank you for choosing ${SHOP_NAME}!\n`;
            msg += `Device: ${job.deviceBrand} ${job.deviceModel}\n`;
            msg += `Status: ${job.status}\n`;
            msg += `Repair Price: Rs ${job.repairPrice.toFixed(2)}\n`;
            msg += `Paid: Rs ${job.amountPaid.toFixed(2)}\n`;
            msg += `Balance Due: Rs ${balance.toFixed(2)}\n\n`;
            msg += `üìç Visit us to collect your device.\n`;
            msg += `‚òéÔ∏è Contact: ${HOTLINE}\n`;
            msg += `üôè Thank you for your trust!`;
            return msg;
        }

        // Send SMS
        function sendSMS(phone, text) {
            if (!phone) {
                alert("‚ö†Ô∏è No phone number to send SMS!");
                return;
            }

            const encodedText = encodeURIComponent(text);
            const smsUrl = `sms:${phone}?body=${encodedText}`;
            window.location.href = smsUrl;
        }

        // Format as LKR
        function formatLKR(amount) {
            return new Intl.NumberFormat('si-LK', {
                style: 'currency',
                currency: 'LKR',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Get status color class
        function getStatusClass(status) {
            if (status === 'Delivered') return 'delivered';
            if (status === 'Ready for Pickup') return 'ready';
            if (status === 'In Progress') return 'progress';
            return 'pending';
        }

        // Generate Receipt HTML
        function generateReceiptHTML(job) {
            const balance = job.repairPrice - job.amountPaid;
            const now = new Date().toLocaleString();
            
            return `
                <div style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
                    <h2 style="margin:0; font-size: 18px;">${SHOP_NAME}</h2>
                    <p style="margin:5px 0; font-size: 12px;">Hotline: ${HOTLINE}</p>
                    <p style="margin:5px 0; font-size: 12px;">REPAIR RECEIPT</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Job Number:</strong> ${job.jobNumber}<br>
                    <strong>Date:</strong> ${now}<br>
                    <strong>Customer:</strong> ${job.customerName}<br>
                    <strong>Phone:</strong> ${job.customerPhone}<br>
                    ${job.customerAddress ? `<strong>Address:</strong> ${job.customerAddress}<br>` : ''}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Device:</strong> ${job.deviceBrand} ${job.deviceModel}<br>
                    <strong>Issue:</strong> ${job.issueDesc || 'N/A'}<br>
                    <strong>Status:</strong> ${job.status}
                </div>
                
                <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Repair Price:</span>
                        <span>${formatLKR(job.repairPrice)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Amount Paid:</span>
                        <span>${formatLKR(job.amountPaid)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px;">
                        <span>BALANCE DUE:</span>
                        <span>${formatLKR(balance)}</span>
                    </div>
                </div>
                
                <div style="text-align:center; margin-top: 20px; font-style: italic; font-size: 12px;">
                    <p>Thank you for your business!</p>
                    <p>Keep this receipt for your records.</p>
                </div>
            `;
        }

        // Print Receipt
        function printReceipt(job) {
            receiptContent.innerHTML = generateReceiptHTML(job);
            window.print();
            // Clear after print (optional)
            setTimeout(() => {
                receiptContent.innerHTML = '';
            }, 1000);
        }

        // Render Jobs
        function renderJobs(filter = '') {
            jobListEl.innerHTML = '';
            if (jobs.length === 0) {
                jobListEl.innerHTML = '<p>No jobs yet. Add your first repair!</p>';
                return;
            }

            let filteredJobs = jobs;

            if (currentTab === 'active') {
                filteredJobs = jobs.filter(job => job.status !== 'Delivered');
            }

            if (filter) {
                const term = filter.toLowerCase();
                filteredJobs = filteredJobs.filter(job =>
                    job.customerName.toLowerCase().includes(term) ||
                    job.customerPhone.includes(term) ||
                    (job.jobNumber && job.jobNumber.toLowerCase().includes(term))
                );
            }

            if (filteredJobs.length === 0) {
                jobListEl.innerHTML = `<p>‚ùå No ${currentTab} jobs found.</p>`;
                return;
            }

            filteredJobs.forEach(job => {
                const balance = job.repairPrice - job.amountPaid;
                let paymentStatus = "Unpaid";
                let paymentClass = "unpaid";

                if (balance <= 0 && job.repairPrice > 0) {
                    paymentStatus = "Paid";
                    paymentClass = "paid";
                } else if (job.amountPaid > 0) {
                    paymentStatus = "Partial";
                    paymentClass = "partial";
                }

                const jobEl = document.createElement('div');
                jobEl.className = 'job';
                jobEl.dataset.id = job.id;

                jobEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <strong>üë®‚Äçüîß ${job.customerName}</strong>
                        <span class="job-number">${job.jobNumber}</span>
                    </div>
                    <strong>üìû ${job.customerPhone}</strong><br>
                    <strong>üè† Address:</strong> ${job.customerAddress || 'N/A'}<br>
                    <strong>üì± ${job.deviceBrand} ${job.deviceModel}</strong><br>
                    <strong>‚ùó Issue:</strong> ${job.issueDesc || 'N/A'}<br>
                    <strong>üìÖ Received:</strong> ${job.repairDate} | <strong>üöö Expected:</strong> ${job.deliveryDate}<br>
                    <strong>üè∑Ô∏è Status:</strong> 
                    <span class="job-status ${getStatusClass(job.status)}">
                        ${job.status}
                    </span><br>
                    <strong>üí∞ Price: ${formatLKR(job.repairPrice)} | Paid: ${formatLKR(job.amountPaid)} | Due: ${formatLKR(balance)}</strong><br>
                    <strong>üí≥ Payment:</strong> <span class="payment-status ${paymentClass}">${paymentStatus}</span><br>
                    <small>üíæ Saved: ${job.createdAt}</small>
                    <div class="job-actions" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
                    <hr>
                `;

                const actionsContainer = jobEl.querySelector('.job-actions');

                // Complete Job Button
                if (job.status !== 'Delivered') {
                    const completeBtn = document.createElement('button');
                    completeBtn.className = 'complete-btn';
                    completeBtn.textContent = '‚úÖ Complete Repair';
                    completeBtn.addEventListener('click', () => {
                        currentJobId = job.id;
                        modalPrice.value = '';
                        modalPaid.value = '';
                        completeModal.style.display = 'flex';
                    });
                    actionsContainer.appendChild(completeBtn);
                }

                // Edit Price & Payment Button
                const editPaymentBtn = document.createElement('button');
                editPaymentBtn.className = 'edit-payment-btn';
                editPaymentBtn.textContent = '‚úèÔ∏è Edit Price & Payment';
                editPaymentBtn.addEventListener('click', () => {
                    currentJobId = job.id;
                    const foundJob = jobs.find(j => j.id === job.id);
                    if (foundJob) {
                        editPrice.value = foundJob.repairPrice;
                        editPaid.value = foundJob.amountPaid;
                    }
                    paymentModal.style.display = 'flex';
                });
                actionsContainer.appendChild(editPaymentBtn);

                // Edit Job Details Button
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'üìù Edit Job Details';
                editBtn.addEventListener('click', () => {
                    currentJobId = job.id;
                    const foundJob = jobs.find(j => j.id === job.id);
                    if (foundJob) {
                        editJobId.value = foundJob.id;
                        editJobNumber.value = foundJob.jobNumber;
                        editCustomerName.value = foundJob.customerName;
                        editCustomerPhone.value = foundJob.customerPhone;
                        editCustomerAddress.value = foundJob.customerAddress;
                        editDeviceBrand.value = foundJob.deviceBrand;
                        editDeviceModel.value = foundJob.deviceModel;
                        editIssueDesc.value = foundJob.issueDesc;
                        editRepairDate.value = foundJob.repairDate;
                        editDeliveryDate.value = foundJob.deliveryDate;
                        editStatus.value = foundJob.status;
                    }
                    editJobModal.style.display = 'flex';
                });
                actionsContainer.appendChild(editBtn);

                // Send SMS Button
                const smsBtn = document.createElement('button');
                smsBtn.className = 'sms-btn';
                smsBtn.textContent = 'üì≤ Send SMS Update';
                smsBtn.addEventListener('click', () => {
                    const foundJob = jobs.find(j => j.id === job.id);
                    if (foundJob) {
                        const smsText = generateDetailedSMSText(foundJob);
                        sendSMS(foundJob.customerPhone, smsText);
                    }
                });
                actionsContainer.appendChild(smsBtn);

                // üßæ Generate Receipt Button
                const receiptBtn = document.createElement('button');
                receiptBtn.className = 'receipt-btn';
                receiptBtn.textContent = 'üßæ Generate Receipt';
                receiptBtn.addEventListener('click', () => {
                    const foundJob = jobs.find(j => j.id === job.id);
                    if (foundJob) {
                        printReceipt(foundJob);
                    }
                });
                actionsContainer.appendChild(receiptBtn);

                jobListEl.appendChild(jobEl);
            });
        }

        // Save Job + Auto-Generate Job Number + Auto-SMS
        saveBtn.addEventListener('click', () => {
            const jobNumber = generateJobNumber();

            const job = {
                id: Date.now(),
                jobNumber: jobNumber,
                customerName: document.getElementById('customerName').value.trim(),
                customerPhone: document.getElementById('customerPhone').value.trim(),
                customerAddress: document.getElementById('customerAddress').value.trim(),
                deviceBrand: document.getElementById('deviceBrand').value.trim(),
                deviceModel: document.getElementById('deviceModel').value.trim(),
                issueDesc: document.getElementById('issueDesc').value.trim(),
                repairPrice: 0,
                amountPaid: 0,
                repairDate: document.getElementById('repairDate').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                status: document.getElementById('status').value,
                createdAt: new Date().toLocaleString()
            };

            if (!job.customerName || !job.customerPhone || !job.deviceModel) {
                alert("‚ö†Ô∏è Please fill Customer Name, Phone, and Device Model!");
                return;
            }

            jobs.push(job);
            saveToStorage();
            renderJobs('');

            const receivedSMS = generateReceivedSMSText(
                job.customerName,
                job.deviceBrand,
                job.deviceModel,
                job.jobNumber
            );
            sendSMS(job.customerPhone, receivedSMS);

            resetForm();
            alert(`‚úÖ Repair Job ${job.jobNumber} Saved & SMS Sent to Customer!`);
        });

        // Save from Complete Modal ‚Üí Send SMS with Price & Payment
        modalSaveBtn.addEventListener('click', () => {
            if (!currentJobId) return;

            const price = parseFloat(modalPrice.value) || 0;
            const paid = parseFloat(modalPaid.value) || 0;

            if (price < 0 || paid < 0) {
                alert("‚ö†Ô∏è Price and payment must be 0 or positive.");
                return;
            }

            const job = jobs.find(j => j.id === currentJobId);
            if (job) {
                job.repairPrice = price;
                job.amountPaid = paid;
                job.status = "Ready for Pickup";

                saveToStorage();
                renderJobs(searchInput.value.trim());

                const readySMS = generateReadySMSText(
                    job.customerName,
                    job.jobNumber,
                    job.repairPrice,
                    job.amountPaid
                );
                sendSMS(job.customerPhone, readySMS);

                alert("üéâ Job marked as READY FOR PICKUP! SMS with payment details sent to customer.");
            }

            completeModal.style.display = 'none';
        });

        // Save from Edit Payment Modal
        editSaveBtn.addEventListener('click', () => {
            if (!currentJobId) return;

            const price = parseFloat(editPrice.value) || 0;
            const paid = parseFloat(editPaid.value) || 0;

            if (price < 0 || paid < 0) {
                alert("‚ö†Ô∏è Price and payment must be 0 or positive.");
                return;
            }

            const job = jobs.find(j => j.id === currentJobId);
            if (job) {
                job.repairPrice = price;
                job.amountPaid = paid;
                saveToStorage();
                renderJobs(searchInput.value.trim());
                alert("‚úÖ Price & Payment updated!");
            }

            paymentModal.style.display = 'none';
        });

        // Save from Edit Job Modal
        saveEditBtn.addEventListener('click', () => {
            if (!currentJobId) return;

            const job = jobs.find(j => j.id === currentJobId);
            if (job) {
                job.customerName = editCustomerName.value.trim();
                job.customerPhone = editCustomerPhone.value.trim();
                job.customerAddress = editCustomerAddress.value.trim();
                job.deviceBrand = editDeviceBrand.value.trim();
                job.deviceModel = editDeviceModel.value.trim();
                job.issueDesc = editIssueDesc.value.trim();
                job.repairDate = editRepairDate.value;
                job.deliveryDate = editDeliveryDate.value;
                job.status = editStatus.value;

                saveToStorage();
                renderJobs(searchInput.value.trim());
                alert("‚úÖ Job Details Updated!");
            }

            editJobModal.style.display = 'none';
        });

        // Cancel Modals
        modalCancelBtn.addEventListener('click', () => completeModal.style.display = 'none');
        editCancelBtn.addEventListener('click', () => paymentModal.style.display = 'none');
        cancelEditBtn.addEventListener('click', () => editJobModal.style.display = 'none');

        // Close modals if click outside
        window.addEventListener('click', (e) => {
            if (e.target === completeModal) completeModal.style.display = 'none';
            if (e.target === paymentModal) paymentModal.style.display = 'none';
            if (e.target === editJobModal) editJobModal.style.display = 'none';
        });

        // Save to localStorage
        function saveToStorage() {
            localStorage.setItem('repairJobs', JSON.stringify(jobs));
        }

        // Reset Form
        function resetForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('deviceBrand').value = '';
            document.getElementById('deviceModel').value = '';
            document.getElementById('issueDesc').value = '';
            document.getElementById('status').value = 'Pending';
            document.getElementById('repairDate').valueAsDate = new Date();
            document.getElementById('deliveryDate').valueAsDate = new Date(Date.now() + 86400000 * 3);
        }

        // Export Jobs
        exportBtn.addEventListener('click', () => {
            if (jobs.length === 0) {
                alert("No jobs to export!");
                return;
            }

            const dataStr = JSON.stringify(jobs, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'pathirage-electronics-jobs-' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Search
        searchBtn.addEventListener('click', () => {
            renderJobs(searchInput.value.trim());
        });

        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });

        // Initialize
        renderJobs();
    </script>
</body>
</html>