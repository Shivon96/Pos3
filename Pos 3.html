<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∂¥‡∂≠‡∑í‡∂ª‡∂ú‡∑ö ‡∂â‡∂Ω‡∑ô‡∂ö‡∑ä‡∂ß‡∑ä‚Äç‡∂ª‡∑ú‡∂±‡∑í‡∂ö‡∑ä‡∑É‡∑ä - ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <style>
        body {
            font-family: 'Iskoola Pota', 'Malithi Web', Arial, sans-serif;
            padding: 15px;
            background: #f8f9fa;
            max-width: 100%;
            margin: 0 auto;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #007bff;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            font-size: 16px;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            margin-top: 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .job {
            background: #f1f1f1;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            position: relative;
        }
        .job-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }
        .payment-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }
        .delivered { background: green; }
        .ready { background: orange; }
        .progress { background: #007bff; }
        .pending { background: red; }
        .paid { background: green; }
        .partial { background: orange; }
        .unpaid { background: red; }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .search-box {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 5px;
            margin: 15px 0;
        }
        #exportBtn {
            background: #28a745;
        }
        #searchBtn {
            background: #ffc107;
            color: #212529;
        }
        #clearSearchBtn {
            background: #dc3545;
            color: white;
        }
        .complete-btn, .edit-btn, .edit-payment-btn, .sms-btn, .deliver-btn {
            padding: 6px 10px;
            font-size: 12px;
            margin-top: 5px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .complete-btn, .deliver-btn { background: #28a745; color: white; }
        .edit-btn { background: #17a2b8; color: white; }
        .edit-payment-btn { background: #ffc107; color: #212529; }
        .sms-btn { background: #007bff; color: white; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: left;
        }
        .modal-title {
            margin-top: 0;
            color: #007bff;
            font-size: 18px;
        }
        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f1f1f1;
            border: none;
            font-weight: bold;
            font-size: 16px;
            white-space: nowrap;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }

        /* Footer */
        .footer {
            margin-top: 30px;
            padding: 15px;
            background: #007bff;
            color: white;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
        }

        /* Job Number Badge */
        .job-number {
            background: #6c757d;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± ‡∂¥‡∂≠‡∑í‡∂ª‡∂ú‡∑ö ‡∂â‡∂Ω‡∑ô‡∂ö‡∑ä‡∂ß‡∑ä‚Äç‡∂ª‡∑ú‡∂±‡∑í‡∂ö‡∑ä‡∑É‡∑ä</h1>
        <p style="color: #666; font-size: 14px;">‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫ (LKR)</p>

        <div class="form">
            <label>‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö ‡∂±‡∂∏ *</label>
            <input type="text" id="customerName" placeholder="‡∂ã‡∂Ø‡∑è: ‡∂±‡∑í‡∂ª‡∑ù‡∑Ç‡∂±‡∑ä ‡∂¥‡∑ô‡∂ª‡∑ö‡∂ª‡∑è" required>

            <label>‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫ *</label>
            <input type="tel" id="customerPhone" placeholder="‡∂ã‡∂Ø‡∑è: 0712345678" required>

            <label>‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫</label>
            <textarea id="customerAddress" rows="2" placeholder="‡∂ú‡∑ô‡∂∫‡∑í ‡∂Ö‡∂Ç‡∂ö‡∂∫, ‡∑Ä‡∑ì‡∂Ø‡∑í‡∂∫, ‡∂±‡∂ú‡∂ª‡∂∫"></textarea>

            <label>‡∑Ä‡∑ô‡∑Ö‡∂≥ ‡∂±‡∑è‡∂∏‡∂∫</label>
            <input type="text" id="deviceBrand" placeholder="‡∂ã‡∂Ø‡∑è: Samsung, Apple, Dell">

            <label>‡∂∏‡∑è‡∂Ø‡∑í‡∂Ω‡∑í‡∂∫ *</label>
            <input type="text" id="deviceModel" placeholder="‡∂ã‡∂Ø‡∑è: Galaxy S23, MacBook Pro" required>

            <label>‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</label>
            <textarea id="issueDesc" rows="3" placeholder="‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂ö‡∂ª‡∂±‡∑ä‡∂±..."></textarea>

            <label>‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂Ø‡∑í‡∂±‡∂∫ (‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î)</label>
            <input type="date" id="repairDate">

            <label>‡∂Ö‡∂¥‡∑ö‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂∑‡∑è‡∂ª‡∂Ø‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑í‡∂±‡∂∫</label>
            <input type="date" id="deliveryDate">

            <label>‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫</label>
            <select id="status">
                <option value="Pending">‡∂∂‡∂Ω‡∑è‡∂¥‡∑ú‡∂ª‡∑ú‡∂≠‡∑ä‡∂≠‡∑î‡∑Ä‡∑ô‡∂±‡∑ä</option>
                <option value="In Progress">‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫‡∑ö</option>
                <option value="Ready for Pickup">‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä</option>
            </select>

            <button id="saveBtn">üíæ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è‡∑Ä ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
        </div>

        <div class="actions">
            <input type="text" id="searchInput" class="search-box" placeholder="üîç ‡∂±‡∂∏, ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∑Ñ‡∑ù ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∑ô‡∂±‡∑ä ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂± (‡∂ã‡∂Ø‡∑è: PE-2025-0001)">
            <button id="searchBtn">‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±</button>
            <button id="clearSearchBtn">‡∂∏‡∂ö‡∂±‡∑ä‡∂±</button>
            <button id="exportBtn">üì§ ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∂Ö‡∂¥‡∂±‡∂∫‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="active">üîß ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∑ì ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è</button>
            <button class="tab" data-tab="delivered">üì¶ ‡∂∑‡∑è‡∂ª‡∂Ø‡∑î‡∂±‡∑ä ‡∂∑‡∑è‡∂´‡∑ä‡∂©</button>
            <button class="tab" data-tab="all">üìã ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è</button>
        </div>

        <div id="jobList">
            <!-- Jobs will appear here -->
        </div>

        <div class="footer">
            ‚òéÔ∏è ‡∑Ñ‡∑ú‡∂ß‡∑ä‡∂Ω‡∂∫‡∑í‡∂±‡∑ä: 070 607 7 607<br>
            üõ†Ô∏è ‡∂¥‡∂≠‡∑í‡∂ª‡∂ú‡∑ö ‡∂â‡∂Ω‡∑ô‡∂ö‡∑ä‡∂ß‡∑ä‚Äç‡∂ª‡∑ú‡∂±‡∑í‡∂ö‡∑ä‡∑É‡∑ä - ‡∂î‡∂∂‡∑ö ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ö‡∂¥‡∑í ‡∂ú‡∑û‡∂ª‡∑Ä‡∂∫‡∑ô‡∂±‡∑ä ‡∑É‡∑ê‡∂Ω‡∂ö‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫
        </div>
    </div>

    <!-- Complete Job Modal -->
    <div id="completeModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">‚úÖ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è‡∑Ä ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h3>
            <label>‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂∏‡∑í‡∂Ω (LKR)</label>
            <input type="number" id="modalPrice" min="0" step="0.01" placeholder="‡∂ã‡∂Ø‡∑è: 1500.00">

            <label>‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è‡∑Ä‡∂ß ‡∂Ö‡∂ú‡∂∫‡∂∏‡∑ä ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ (LKR)</label>
            <input type="number" id="modalPaid" min="0" step="0.01" placeholder="‡∂ã‡∂Ø‡∑è: 500.00">

            <div class="modal-actions">
                <button id="modalSaveBtn">üíæ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂± & ‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                <button id="modalCancelBtn">‚ùå ‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
            </div>
        </div>
    </div>

    <!-- Edit Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">‚úèÔ∏è ‡∂∏‡∑í‡∂Ω ‡∑É‡∑Ñ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h3>
            <label>‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂∏‡∑í‡∂Ω (LKR)</label>
            <input type="number" id="editPrice" min="0" step="0.01" placeholder="‡∂ã‡∂Ø‡∑è: 1500.00">

            <label>‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω (LKR)</label>
            <input type="number" id="editPaid" min="0" step="0.01" placeholder="‡∂ã‡∂Ø‡∑è: 1000.00">

            <div class="modal-actions">
                <button id="editSaveBtn">üíæ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä‡∂ö‡∂∏‡∑ä ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                <button id="editCancelBtn">‚ùå ‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div id="editJobModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">‚úèÔ∏è ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h3>
            <input type="hidden" id="editJobId">
            <label>‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label>
            <input type="text" id="editJobNumber" readonly>
            
            <label>‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö ‡∂±‡∂∏</label>
            <input type="text" id="editCustomerName" placeholder="‡∂ã‡∂Ø‡∑è: ‡∂±‡∑í‡∂ª‡∑ù‡∑Ç‡∂±‡∑ä ‡∂¥‡∑ô‡∂ª‡∑ö‡∂ª‡∑è">

            <label>‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫</label>
            <input type="tel" id="editCustomerPhone" placeholder="‡∂ã‡∂Ø‡∑è: 0712345678">

            <label>‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫</label>
            <textarea id="editCustomerAddress" rows="2" placeholder="‡∂ú‡∑ô‡∂∫‡∑í ‡∂Ö‡∂Ç‡∂ö‡∂∫, ‡∑Ä‡∑ì‡∂Ø‡∑í‡∂∫, ‡∂±‡∂ú‡∂ª‡∂∫"></textarea>

            <label>‡∑Ä‡∑ô‡∑Ö‡∂≥ ‡∂±‡∑è‡∂∏‡∂∫</label>
            <input type="text" id="editDeviceBrand" placeholder="‡∂ã‡∂Ø‡∑è: Samsung, Apple, Dell">

            <label>‡∂∏‡∑è‡∂Ø‡∑í‡∂Ω‡∑í‡∂∫</label>
            <input type="text" id="editDeviceModel" placeholder="‡∂ã‡∂Ø‡∑è: Galaxy S23, MacBook Pro">

            <label>‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</label>
            <textarea id="editIssueDesc" rows="3" placeholder="‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂ö‡∂ª‡∂±‡∑ä‡∂±..."></textarea>

            <label>‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂Ø‡∑í‡∂±‡∂∫</label>
            <input type="date" id="editRepairDate">

            <label>‡∂Ö‡∂¥‡∑ö‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂∑‡∑è‡∂ª‡∂Ø‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑í‡∂±‡∂∫</label>
            <input type="date" id="editDeliveryDate">

            <label>‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫</label>
            <select id="editStatus">
                <option value="Pending">‡∂∂‡∂Ω‡∑è‡∂¥‡∑ú‡∂ª‡∑ú‡∂≠‡∑ä‡∂≠‡∑î‡∑Ä‡∑ô‡∂±‡∑ä</option>
                <option value="In Progress">‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫‡∑ö</option>
                <option value="Ready for Pickup">‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä</option>
                <option value="Delivered">‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠</option>
            </select>

            <div class="modal-actions">
                <button id="saveEditBtn">üíæ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä‡∂ö‡∂∏‡∑ä ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                <button id="cancelEditBtn">‚ùå ‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
            </div>
        </div>
    </div>

    <script>
        let jobs = JSON.parse(localStorage.getItem('repairJobs')) || [];
        const saveBtn = document.getElementById('saveBtn');
        const jobListEl = document.getElementById('jobList');
        const exportBtn = document.getElementById('exportBtn');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const tabs = document.querySelectorAll('.tab');

        // Modal Elements
        const completeModal = document.getElementById('completeModal');
        const paymentModal = document.getElementById('paymentModal');
        const editJobModal = document.getElementById('editJobModal');

        const modalPrice = document.getElementById('modalPrice');
        const modalPaid = document.getElementById('modalPaid');
        const editPrice = document.getElementById('editPrice');
        const editPaid = document.getElementById('editPaid');

        const editJobId = document.getElementById('editJobId');
        const editJobNumber = document.getElementById('editJobNumber');
        const editCustomerName = document.getElementById('editCustomerName');
        const editCustomerPhone = document.getElementById('editCustomerPhone');
        const editCustomerAddress = document.getElementById('editCustomerAddress');
        const editDeviceBrand = document.getElementById('editDeviceBrand');
        const editDeviceModel = document.getElementById('editDeviceModel');
        const editIssueDesc = document.getElementById('editIssueDesc');
        const editRepairDate = document.getElementById('editRepairDate');
        const editDeliveryDate = document.getElementById('editDeliveryDate');
        const editStatus = document.getElementById('editStatus');

        const modalSaveBtn = document.getElementById('modalSaveBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const editSaveBtn = document.getElementById('editSaveBtn');
        const editCancelBtn = document.getElementById('editCancelBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        let currentJobId = null;
        let currentTab = 'active'; // active | delivered | all

        // Shop Info
        const SHOP_NAME = "‡∂¥‡∂≠‡∑í‡∂ª‡∂ú‡∑ö ‡∂â‡∂Ω‡∑ô‡∂ö‡∑ä‡∂ß‡∑ä‚Äç‡∂ª‡∑ú‡∂±‡∑í‡∂ö‡∑ä‡∑É‡∑ä";
        const HOTLINE = "070 607 7 607";

        // Set today's date as default
        document.getElementById('repairDate').valueAsDate = new Date();
        document.getElementById('deliveryDate').valueAsDate = new Date(Date.now() + 86400000 * 3);

        // Tab Switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                renderJobs(searchInput.value.trim());
            });
        });

        // Generate next bill number
        function generateJobNumber() {
            const year = new Date().getFullYear();
            let nextNumber = 1;

            const currentYearJobs = jobs.filter(job => job.jobNumber && job.jobNumber.startsWith(`PE-${year}-`));
            if (currentYearJobs.length > 0) {
                const numbers = currentYearJobs.map(job => {
                    const parts = job.jobNumber.split('-');
                    return parseInt(parts[2]) || 0;
                });
                nextNumber = Math.max(...numbers) + 1;
            }

            return `PE-${year}-${nextNumber.toString().padStart(4, '0')}`;
        }

        // Generate RECEIVED SMS Text
        function generateReceivedSMSText(customerName, deviceBrand, deviceModel, jobNumber) {
            return `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${customerName},\n\n${SHOP_NAME} ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í!\n‡∂î‡∂∂‡∑ö ${deviceBrand} ${deviceModel} ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ö‡∂¥ ‡∑Ä‡∑ô‡∂≠ ‡∂Ω‡∑ê‡∂∂‡∑ì ‡∂á‡∂≠.\n\nüìå ‡∂î‡∂∂‡∑ö ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫: ${jobNumber}\n‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑Ä‡∑ñ ‡∑Ä‡∑í‡∂ß ‡∂Ö‡∂¥‡∑í ‡∂Ø‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±‡∑ô‡∂∏‡∑î.\n‚òéÔ∏è ‡∑Ñ‡∑ú‡∂ß‡∑ä‡∂Ω‡∂∫‡∑í‡∂±‡∑ä: ${HOTLINE}\n\n‚Äî ${SHOP_NAME}`;
        }

        // Generate READY SMS Text
        function generateReadySMSText(customerName, jobNumber, repairPrice, amountPaid) {
            const balance = repairPrice - amountPaid;
            let msg = `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${customerName},\n\nüéâ ‡∂¥‡∑î‡∂Ø‡∑î‡∂∏ ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫‡∂ö‡∑ä! ‡∂î‡∂∂‡∑ö ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ${SHOP_NAME} ‡∑Ñ‡∑í ‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä!\n\nüìå ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫: ${jobNumber}\nüí∞ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂∏‡∑í‡∂Ω: Rs ${repairPrice.toFixed(2)}\nüíµ ‡∂Ö‡∂ú‡∂∫‡∂∏‡∑ä ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏: Rs ${amountPaid.toFixed(2)}\nüí≥ ‡∂ú‡∑ô‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∑Å‡∑ö‡∑Ç‡∂∫: Rs ${balance.toFixed(2)}\n\n‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂î‡∂∂‡∑ö ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂â‡∂ö‡∑ä‡∂∏‡∂±‡∑í‡∂±‡∑ä ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ô‡∂±‡∑ä‡∂±.\n‚òéÔ∏è ‡∑Ñ‡∑ú‡∂ß‡∑ä‡∂Ω‡∂∫‡∑í‡∂±‡∑ä: ${HOTLINE}\n‡∂Ö‡∂¥‡∑Ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∑Ä‡∑è‡∑É ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í!`;
            return msg;
        }

        // Generate DELIVERED SMS Text
        function generateDeliveredSMSText(customerName, jobNumber, repairPrice, amountPaid) {
            const balance = repairPrice - amountPaid;
            let msg = `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${customerName},\n\n‚úÖ ‡∂î‡∂∂‡∑ö ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ${SHOP_NAME} ‡∑Ä‡∑ô‡∂≠‡∑í‡∂±‡∑ä ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠!\n\nüìå ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫: ${jobNumber}\nüí∞ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂∏‡∑î‡∂Ø‡∂Ω: Rs ${repairPrice.toFixed(2)}\nüíµ ‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω: Rs ${amountPaid.toFixed(2)}\n${balance > 0 ? `üí≥ ‡∂¥‡∑Ä‡∂≠‡∑ä‡∑Ä‡∑è ‡∂ú‡∑ô‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∑Å‡∑ö‡∑Ç‡∂∫: Rs ${balance.toFixed(2)}\n‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂â‡∂ö‡∑ä‡∂∏‡∂±‡∑í‡∂±‡∑ä ‡∂ú‡∑ô‡∑Ä‡∂±‡∑ä‡∂±.` : '‚úÖ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä ‡∂ú‡∑ô‡∑Ä‡∑è ‡∂á‡∂≠'}\n\n‡∂Ö‡∂¥‡∑Ä ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í!\n‚òéÔ∏è ‡∑Ñ‡∑ú‡∂ß‡∑ä‡∂Ω‡∂∫‡∑í‡∂±‡∑ä: ${HOTLINE}\n\n‚Äî ${SHOP_NAME}`;
            return msg;
        }

        // Generate Detailed SMS Text
        function generateDetailedSMSText(job) {
            const balance = job.repairPrice - job.amountPaid;
            let msg = `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${job.customerName},\n\n`;
            msg += `üìå ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫: ${job.jobNumber}\n`;
            msg += `${SHOP_NAME} ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í!\n`;
            msg += `‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫: ${job.deviceBrand} ${job.deviceModel}\n`;
            msg += `‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫: ${job.status}\n`;
            msg += `‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂∏‡∑í‡∂Ω: Rs ${job.repairPrice.toFixed(2)}\n`;
            msg += `‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω: Rs ${job.amountPaid.toFixed(2)}\n`;
            msg += `‡∂ú‡∑ô‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∑Å‡∑ö‡∑Ç‡∂∫: Rs ${balance.toFixed(2)}\n\n`;
            msg += `üìç ‡∂î‡∂∂‡∑ö ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂¥ ‡∑Ä‡∑ô‡∂≠ ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ô‡∂±‡∑ä‡∂±.\n`;
            msg += `‚òéÔ∏è ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∑Ä‡∂±‡∑ä‡∂±: ${HOTLINE}\n`;
            msg += `üôè ‡∂î‡∂∂‡∑ö ‡∑Ä‡∑í‡∑Å‡∑ä‡∑Ä‡∑è‡∑É‡∂∫‡∂ß ‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í!`;
            return msg;
        }

        // Send SMS
        function sendSMS(phone, text) {
            if (!phone) {
                alert("‚ö†Ô∏è SMS ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏‡∂ß ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠!");
                return;
            }

            const encodedText = encodeURIComponent(text);
            const smsUrl = `sms:${phone}?body=${encodedText}`;
            window.location.href = smsUrl;
        }

        // Format as LKR
        function formatLKR(amount) {
            return new Intl.NumberFormat('si-LK', {
                style: 'currency',
                currency: 'LKR',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Get status color class
        function getStatusClass(status) {
            if (status === 'Delivered') return 'delivered';
            if (status === 'Ready for Pickup') return 'ready';
            if (status === 'In Progress') return 'progress';
            return 'pending';
        }

        // Render Jobs
        function renderJobs(filter = '') {
            jobListEl.innerHTML = '';
            if (jobs.length === 0) {
                jobListEl.innerHTML = '<p>‡∂≠‡∑Ä‡∂∏ ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠. ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö‡∂∏‡∑î ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è‡∑Ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!</p>';
                return;
            }

            let filteredJobs = jobs;

            if (currentTab === 'active') {
                filteredJobs = jobs.filter(job => job.status !== 'Delivered');
            } else if (currentTab === 'delivered') {
                filteredJobs = jobs.filter(job => job.status === 'Delivered');
            }

            if (filter) {
                const term = filter.toLowerCase();
                filteredJobs = filteredJobs.filter(job =>
                    job.customerName.toLowerCase().includes(term) ||
                    job.customerPhone.includes(term) ||
                    (job.jobNumber && job.jobNumber.toLowerCase().includes(term))
                );
            }

            // Sort by newest first
            filteredJobs.sort((a, b) => b.id - a.id);

            if (filteredJobs.length === 0) {
                let message = "‚ùå ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫.";
                if (currentTab === 'active') message = "‚ùå ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∑ì ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫.";
                else if (currentTab === 'delivered') message = "‚ùå ‡∂∑‡∑è‡∂ª‡∂Ø‡∑î‡∂±‡∑ä ‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫.";
                else if (currentTab === 'all') message = "‚ùå ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫.";

                jobListEl.innerHTML = `<p>${message}</p>`;
                return;
            }

            filteredJobs.forEach(job => {
                const balance = job.repairPrice - job.amountPaid;
                let paymentStatus = "‡∂ú‡∑ô‡∑Ä‡∑è ‡∂±‡∑ê‡∂≠";
                let paymentClass = "unpaid";

                if (balance <= 0 && job.repairPrice > 0) {
                    paymentStatus = "‡∂ú‡∑ô‡∑Ä‡∑è ‡∂á‡∂≠";
                    paymentClass = "paid";
                } else if (job.amountPaid > 0) {
                    paymentStatus = "‡∂Ö‡∂ª‡∑ä‡∂∞ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏";
                    paymentClass = "partial";
                }

                const jobEl = document.createElement('div');
                jobEl.className = 'job';
                jobEl.dataset.id = job.id;

                jobEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <strong>üë®‚Äçüîß ${job.customerName}</strong>
                        <span class="job-number">${job.jobNumber}</span>
                    </div>
                    <strong>üìû ${job.customerPhone}</strong><br>
                    <strong>üè† ‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫:</strong> ${job.customerAddress || 'N/A'}<br>
                    <strong>üì± ${job.deviceBrand} ${job.deviceModel}</strong><br>
                    <strong>‚ùó ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä:</strong> ${job.issueDesc || 'N/A'}<br>
                    <strong>üìÖ ‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î:</strong> ${job.repairDate} | <strong>üöö ‡∂Ö‡∂¥‡∑ö‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠:</strong> ${job.deliveryDate}<br>
                    <strong>üè∑Ô∏è ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫:</strong> 
                    <span class="job-status ${getStatusClass(job.status)}">
                        ${job.status === 'Pending' ? '‡∂∂‡∂Ω‡∑è‡∂¥‡∑ú‡∂ª‡∑ú‡∂≠‡∑ä‡∂≠‡∑î‡∑Ä‡∑ô‡∂±‡∑ä' : 
                          job.status === 'In Progress' ? '‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫‡∑ö' : 
                          job.status === 'Ready for Pickup' ? '‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä' : '‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠'}
                    </span><br>
                    <strong>üí∞ ‡∂∏‡∑í‡∂Ω: ${formatLKR(job.repairPrice)} | ‡∂ú‡∑ô‡∑Ä‡∑ñ: ${formatLKR(job.amountPaid)} | ‡∂ú‡∑ô‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î: ${formatLKR(balance)}</strong><br>
                    <strong>üí≥ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏:</strong> <span class="payment-status ${paymentClass}">${paymentStatus}</span><br>
                    <small>üíæ ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑î‡∂´‡∑î: ${job.createdAt}</small>
                    <div class="job-actions" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
                    <hr>
                `;

                const actionsContainer = jobEl.querySelector('.job-actions');

                // Complete Job Button
                if (job.status !== 'Delivered' && job.status !== 'Ready for Pickup') {
                    const completeBtn = document.createElement('button');
                    completeBtn.className = 'complete-btn';
                    completeBtn.textContent = '‚úÖ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è‡∑Ä ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±';
                    completeBtn.addEventListener('click', () => {
                        currentJobId = job.id;
                        modalPrice.value = '';
                        modalPaid.value = '';
                        completeModal.style.display = 'flex';
                        modalPrice.focus();
                    });
                    actionsContainer.appendChild(completeBtn);
                }

                // Mark as Delivered (only if Ready for Pickup)
                if (job.status === 'Ready for Pickup') {
                    const deliverBtn = document.createElement('button');
                    deliverBtn.className = 'deliver-btn';
                    deliverBtn.textContent = 'üì¶ ‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠‡∑í ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±';
                    deliverBtn.addEventListener('click', () => {
                        const foundJob = jobs.find(j => j.id === job.id);
                        if (foundJob) {
                            const balance = foundJob.repairPrice - foundJob.amountPaid;
                            if (balance > 0) {
                                alert("‚ö†Ô∏è ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂≠‡∑ô‡∂ö‡∑ä ‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠‡∑í ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∑Ö ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö.");
                                return;
                            }
                            foundJob.status = "Delivered";
                            saveToStorage();
                            renderJobs(searchInput.value.trim());

                            const deliveredSMS = generateDeliveredSMSText(
                                foundJob.customerName,
                                foundJob.jobNumber,
                                foundJob.repairPrice,
                                foundJob.amountPaid
                            );
                            sendSMS(foundJob.customerPhone, deliveredSMS);

                            alert(`‚úÖ ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è‡∑Ä ${foundJob.jobNumber} ‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠‡∑í ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑í. SMS ‡∂∫‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑í.`);
                        }
                    });
                    actionsContainer.appendChild(deliverBtn);
                }

                // Edit Price & Payment Button
                const editPaymentBtn = document.createElement('button');
                editPaymentBtn.className = 'edit-payment-btn';
                editPaymentBtn.textContent = '‚úèÔ∏è ‡∂∏‡∑í‡∂Ω ‡∑É‡∑Ñ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±';
                editPaymentBtn.addEventListener('click', () => {
                    currentJobId = job.id;
                    const foundJob = jobs.find(j => j.id === job.id);
                    if (foundJob) {
                        editPrice.value = foundJob.repairPrice;
                        editPaid.value = foundJob.amountPaid;
                    }
                    paymentModal.style.display = 'flex';
                    editPrice.focus();
                });
                actionsContainer.appendChild(editPaymentBtn);

                // Edit Job Details Button
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'üìù ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±';
                editBtn.addEventListener('click', () => {
                    currentJobId = job.id;
                    const foundJob = jobs.find(j => j.id === job.id);
                    if (foundJob) {
                        editJobId.value = foundJob.id;
                        editJobNumber.value = foundJob.jobNumber;
                        editCustomerName.value = foundJob.customerName;
                        editCustomerPhone.value = foundJob.customerPhone;
                        editCustomerAddress.value = foundJob.customerAddress;
                        editDeviceBrand.value = foundJob.deviceBrand;
                        editDeviceModel.value = foundJob.deviceModel;
                        editIssueDesc.value = foundJob.issueDesc;
                        editRepairDate.value = foundJob.repairDate;
                        editDeliveryDate.value = foundJob.deliveryDate;
                        editStatus.value = foundJob.status;
                    }
                    editJobModal.style.display = 'flex';
                    editCustomerName.focus();
                });
                actionsContainer.appendChild(editBtn);

                // Send SMS Button
                const smsBtn = document.createElement('button');
                smsBtn.className = 'sms-btn';
                smsBtn.textContent = 'üì≤ SMS ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±';
                if (!job.customerPhone) {
                    smsBtn.disabled = true;
                    smsBtn.style.opacity = 0.5;
                }
                smsBtn.addEventListener('click', () => {
                    const foundJob = jobs.find(j => j.id === job.id);
                    if (foundJob) {
                        const smsText = generateDetailedSMSText(foundJob);
                        sendSMS(foundJob.customerPhone, smsText);
                    }
                });
                actionsContainer.appendChild(smsBtn);

                jobListEl.appendChild(jobEl);
            });
        }

        // Save Job + Auto-Generate Job Number + Auto-SMS
        saveBtn.addEventListener('click', () => {
            const jobNumber = generateJobNumber();

            const job = {
                id: Date.now(),
                jobNumber: jobNumber,
                customerName: document.getElementById('customerName').value.trim(),
                customerPhone: document.getElementById('customerPhone').value.trim(),
                customerAddress: document.getElementById('customerAddress').value.trim(),
                deviceBrand: document.getElementById('deviceBrand').value.trim(),
                deviceModel: document.getElementById('deviceModel').value.trim(),
                issueDesc: document.getElementById('issueDesc').value.trim(),
                repairPrice: 0,
                amountPaid: 0,
                repairDate: document.getElementById('repairDate').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                status: document.getElementById('status').value,
                createdAt: new Date().toLocaleString()
            };

            if (!job.customerName || !job.customerPhone || !job.deviceModel) {
                alert("‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö ‡∂±‡∂∏, ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∑É‡∑Ñ ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú ‡∂∏‡∑è‡∂Ø‡∑í‡∂Ω‡∑í‡∂∫ ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂±!");
                return;
            }

            jobs.push(job);
            saveToStorage();
            renderJobs('');

            const receivedSMS = generateReceivedSMSText(
                job.customerName,
                job.deviceBrand,
                job.deviceModel,
                job.jobNumber
            );
            sendSMS(job.customerPhone, receivedSMS);

            resetForm();
            alert(`‚úÖ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è‡∑Ä ${job.jobNumber} ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂± ‡∂Ω‡∂Ø‡∑í & ‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö‡∂∫‡∑è‡∂ß SMS ‡∂∫‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑í!`);
        });

        // Save from Complete Modal ‚Üí Send SMS with Price & Payment
        modalSaveBtn.addEventListener('click', () => {
            if (!currentJobId) return;

            const price = parseFloat(modalPrice.value) || 0;
            const paid = parseFloat(modalPaid.value) || 0;

            if (price < 0 || paid < 0) {
                alert("‚ö†Ô∏è ‡∂∏‡∑í‡∂Ω ‡∑É‡∑Ñ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ 0 ‡∑Ñ‡∑ù ‡∂∞‡∂±‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫.");
                return;
            }

            const job = jobs.find(j => j.id === currentJobId);
            if (job) {
                job.repairPrice = price;
                job.amountPaid = paid;
                job.status = "Ready for Pickup";

                saveToStorage();
                renderJobs(searchInput.value.trim());

                const readySMS = generateReadySMSText(
                    job.customerName,
                    job.jobNumber,
                    job.repairPrice,
                    job.amountPaid
                );
                sendSMS(job.customerPhone, readySMS);

                alert("üéâ ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è‡∑Ä ‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑í! ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂∏‡∂ü SMS ‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö‡∂∫‡∑è‡∂ß ‡∂∫‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑í.");
            }

            completeModal.style.display = 'none';
        });

        // Save from Edit Payment Modal
        editSaveBtn.addEventListener('click', () => {
            if (!currentJobId) return;

            const price = parseFloat(editPrice.value) || 0;
            const paid = parseFloat(editPaid.value) || 0;

            if (price < 0 || paid < 0) {
                alert("‚ö†Ô∏è ‡∂∏‡∑í‡∂Ω ‡∑É‡∑Ñ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ 0 ‡∑Ñ‡∑ù ‡∂∞‡∂±‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫.");
                return;
            }

            const job = jobs.find(j => j.id === currentJobId);
            if (job) {
                job.repairPrice = price;
                job.amountPaid = paid;
                saveToStorage();
                renderJobs(searchInput.value.trim());
                alert("‚úÖ ‡∂∏‡∑í‡∂Ω ‡∑É‡∑Ñ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑í!");
            }

            paymentModal.style.display = 'none';
        });

        // Save from Edit Job Modal ‚Äî WITH PAYMENT VALIDATION FOR DELIVERED
        saveEditBtn.addEventListener('click', () => {
            if (!currentJobId) return;

            const job = jobs.find(j => j.id === currentJobId);
            if (job) {
                job.customerName = editCustomerName.value.trim();
                job.customerPhone = editCustomerPhone.value.trim();
                job.customerAddress = editCustomerAddress.value.trim();
                job.deviceBrand = editDeviceBrand.value.trim();
                job.deviceModel = editDeviceModel.value.trim();
                job.issueDesc = editIssueDesc.value.trim();
                job.repairDate = editRepairDate.value;
                job.deliveryDate = editDeliveryDate.value;
                const newStatus = editStatus.value;

                // Validate required fields
                if (!job.customerName || !job.customerPhone || !job.deviceModel) {
                    alert("‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö ‡∂±‡∂∏, ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∑É‡∑Ñ ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú ‡∂∏‡∑è‡∂Ø‡∑í‡∂Ω‡∑í‡∂∫ ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂±!");
                    return;
                }

                // If setting to "Delivered", enforce payment
                if (newStatus === "Delivered") {
                    const balance = job.repairPrice - job.amountPaid;
                    if (balance > 0) {
                        alert("‚ö†Ô∏è ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂≠‡∑ô‡∂ö‡∑ä '‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠' ‡∂Ω‡∑ô‡∑É ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∑É‡∂ö‡∑É‡∑è ‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö.");
                        return;
                    }

                    // Send Delivered SMS
                    const deliveredSMS = generateDeliveredSMSText(
                        job.customerName,
                        job.jobNumber,
                        job.repairPrice,
                        job.amountPaid
                    );
                    sendSMS(job.customerPhone, deliveredSMS);

                    alert(`‚úÖ ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è‡∑Ä ‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠‡∑í ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑í. ‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö‡∂∫‡∑è‡∂ß SMS ‡∂∫‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑í.`);
                }

                job.status = newStatus;
                saveToStorage();
                renderJobs(searchInput.value.trim());
                alert("‚úÖ ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑í!");
            }

            editJobModal.style.display = 'none';
        });

        // Cancel Modals
        modalCancelBtn.addEventListener('click', () => completeModal.style.display = 'none');
        editCancelBtn.addEventListener('click', () => paymentModal.style.display = 'none');
        cancelEditBtn.addEventListener('click', () => editJobModal.style.display = 'none');

        // Close modals if click outside
        window.addEventListener('click', (e) => {
            if (e.target === completeModal) completeModal.style.display = 'none';
            if (e.target === paymentModal) paymentModal.style.display = 'none';
            if (e.target === editJobModal) editJobModal.style.display = 'none';
        });

        // Save to localStorage
        function saveToStorage() {
            localStorage.setItem('repairJobs', JSON.stringify(jobs));
        }

        // Reset Form
        function resetForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('deviceBrand').value = '';
            document.getElementById('deviceModel').value = '';
            document.getElementById('issueDesc').value = '';
            document.getElementById('status').value = 'Pending';
            document.getElementById('repairDate').valueAsDate = new Date();
            document.getElementById('deliveryDate').valueAsDate = new Date(Date.now() + 86400000 * 3);
        }

        // Export Jobs
        exportBtn.addEventListener('click', () => {
            if (jobs.length === 0) {
                alert("‡∂Ö‡∂¥‡∂±‡∂∫‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠!");
                return;
            }

            const dataStr = JSON.stringify(jobs, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'pathirage-electronics-jobs-' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Search
        searchBtn.addEventListener('click', () => {
            renderJobs(searchInput.value.trim());
        });

        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });

        // Clear Search
        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            renderJobs('');
        });

        // Initialize
        renderJobs();
    </script>
</body>
</html>